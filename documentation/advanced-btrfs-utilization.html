<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="Documentation v3.0.0">


    <title>Advanced BTRFS utilization — Documentation v3.0.0</title>

    <link rel="stylesheet" href="dist/html-elixir-KV3YOVJ3.css" />

    <script defer src="dist/sidebar_items-0B4BC6CB.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>
<link rel="stylesheet" href="assets/doc.css">
  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://kaisenlinux.org/documentation/" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Documentation" />
        </a>

      <div>
        <a href="https://kaisenlinux.org/documentation/" class="sidebar-projectName" translate="no">
Documentation
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v3.0.0
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras="Guides"></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of Documentation</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Advanced BTRFS utilisation</h1>


  </div>


<h2 id="subvolumes" class="section-heading"><a href="#subvolumes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Subvolumes</span></h2><h3 id="explanations" class="section-heading"><a href="#explanations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Explanations</span></h3><p>A subvolume is a branch of the file system that behaves like a file subsystem. it appears as a directory.<br/>It is thanks to these sub-volumes that the creation of snapshots of a directory is possible.</p><h3 id="manual-creation" class="section-heading"><a href="#manual-creation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Manual creation</span></h3><p>To manually create subvolumes to use the snapshost system, we will proceed like this.<br/>Here, the subvolumes that will be created are the same as those created by installing Kaisen Linux with an ISO of revision 1.6.  </p><p>Subvolumes can be created using commands installed via the btrfs-progs package. This package is installed by default in Kaisen Linux if the kaisen-filesystems package is installed, or if BTRFS is the file system used when installing the system.  </p><p>This command can be used to create BTRFS subvolume:<br/><code class="inline">sudo btrfs subvolume create subvolume_name</code></p><h3 id="deletion" class="section-heading"><a href="#deletion" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Deletion</span></h3><p>To delete a BTRFS subvolume, can you proceed like this:<br/><code class="inline">sudo btrfs subvolume delete subvolume_name</code></p><h2 id="snapshots" class="section-heading"><a href="#snapshots" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Snapshots</span></h2><h3 id="explanations-1" class="section-heading"><a href="#explanations-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Explanations</span></h3><p>A snapshot, or restore point, is an image of the file system or one of its subvolumes that you back up at a specific point in time, so that you can access or restore it later. The main goal is to restore a system that has become unstable.</p><p>Once created, a snapshot behaves like an ordinary folder on your file system: you can copy it, move it to external media, rename it...</p><h3 id="snapshots-with-btrfs-commands" class="section-heading"><a href="#snapshots-with-btrfs-commands" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Snapshots with BTRFS commands</span></h3><p>To take a snapshot of the entire system from the command line:<br/><code class="inline">sudo btrfs subvolume snapshot / /opt/snapshot20210330</code>  </p><p>This command will take a snaphsot from the test subvolume (directory). This frozen version of your directory will be accessible through the &quot;/opt/snapshot20210330&quot; directory. The modifications made in each of the two directories are independent. The filesystem manages the changes so that they are transparent to the user (with ext4, it would have been necessary to create a copy of the directory, which would have occupied double the disk space. A snapshot does not consume any additional disk space).  </p><h3 id="restore-snapshot" class="section-heading"><a href="#restore-snapshot" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Restore snapshot</span></h3><p>To restore the snapshot taken previously, the following command can be used:<br/><code class="inline">sudo btrfs subvolume get-default /</code>  </p><h3 id="apt-snapshots" class="section-heading"><a href="#apt-snapshots" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">APT snapshots</span></h3><p>Before the 2.2RC2 release, snapshots taken by the apt-btrfs-snapshot software. This tool has been dropped because it causes a lot of bugs with systemd (it modified the /etc/fstab file). Also, restored snapshots couldn't be deleted.  </p><p>Since the 2.2RC2 release, APT snapshots are handled by the kaisen-timeshift-apt package to fix problems with the previous package used for that (apt-btrfs-snapshot). This tool is the in-house tool developed by the Kaisen Linux team and it's combined with Timeshift to automatically take APT snapshots. The commands to delete or restore a snapshot taken by kaisen-timeshift-apt are the same as those of Timeshift.  </p><p>Whenever APT is used for a package update or installation, a snapshot will be automatically taken.  </p><p>If an upgrade or a package installation goes wrong it is easy to go back with these commands:<br/><code class="inline">sudo timeshift --list</code>  </p><p>This command will list all snapshots taken by apt-btrfs-snapshot.<br/>The names of the snapshots look like this:<br/><code class="inline">2022-10-23_22-36-46</code></p><p>We want to restore the snapshot with the name mentioned above. For that, we will type the command:<br/><code class="inline">sudo timeshift --restore --snapshot 2022-10-23_22-36-46</code><br/>At the next restart, all changes made to the packages will be reverted.</p><p>To delete all snapshots taken by apt-btrfs-snapshot, you must type this command as root or via sudo:<br/><code class="inline">sudo timeshift --delete-all</code></p><p>To delete a specific snapshots with its name, type this command:<br/><code class="inline">sudo timeshift --delete --snapshot 2022-10-23_22-36-46</code></p><p>This functionality can also be completely removed by fully uninstalling the package. In this case, you have to run this command:<br/><code class="inline">sudo apt remove --purge kaisen-timeshift-apt</code>  </p><p>A systemd timer and service are installed by default to remove automatically all snapshots older than 7 days. Manual deletion isn't required, but it's possible to delete them manually.
Snapshots restored can also be deleted with the timeshift --remove command.</p><h2 id="the-kaisen-snapshot-command" class="section-heading"><a href="#the-kaisen-snapshot-command" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">The kaisen-snapshot command</span></h2><p>In version 3.0, the <strong>kaisen-snapshot</strong> command was created. This command is a wrapper for timeshift, making it easier to use on a daily basis.</p><p>Examples of commands to use with the <strong>kaisen-snapshot</strong> command:</p><ul><li>kaisen-snapshot <strong>-c</strong> (or <strong>--create</strong>): Create a snapshot</li><li>kaisen-snapshot <strong>-m</strong> (or <strong>--message</strong>): Custom message for a snapshot (<strong>Perso</strong> is the default value, if this argument is not used)</li><li>kaisen-snapshot <strong>-d</strong> (or <strong>--delete</strong>): Delete a snapshot</li><li>kaisen-snapshot <strong>-a</strong> (or <strong>--delete-all</strong>): Delete all snapshots</li><li>kaisen-snapshot <strong>-r</strong> (or <strong>--restore</strong>): Restore a snapshot</li><li>kaisen-snapshot <strong>-l</strong> (or <strong>--list</strong>): List all snapshots taken</li></ul><p>Examples:</p><ul><li><p>Create a snapshot without custom message:
<code class="inline">sudo kaisen-snapshot -c</code></p></li><li><p>Create a snapshot with the message <strong>Test</strong>:
<code class="inline">sudo kaisen-snapshot -m &quot;Test&quot; -c</code> or <code class="inline">sudo kaisen-snapshot -c -m &quot;Test&quot;</code></p></li><li><p>Delete all snapshots taken:
<code class="inline">sudo kaisen-snapshot -a</code></p></li></ul><h3 id="the-grub-btrfs-package" class="section-heading"><a href="#the-grub-btrfs-package" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">The grub-btrfs package</span></h3><p>Since the 2.2RC2 release, the grub-btrfs package is included by default when Kaisen uses BTRFS as default filesystem. The grub-btrfs package allows to boot on a previously created snapshot directly from the GRUB menu! All taken snapshots will can be restored from the started snapshot!  </p><p>To restore a snapshot, you should use the BTRFS commands or the commands or the commands of the software used to take the snapshots (Timeshift for example, also works with snapshots taken automatically by kaisen-timeshift-apt).  </p><p>On Kaisen Linux, the focus has been on Timeshift to automate the addition to the GRUB menu of BTRFS snapshots taken or deleted with Timeshift (also works with those taken with kaisen-timeshift-apt).  </p><p>All snapshots that are taken or deleted will be automatically added to the GRUB menu via a systemd service within 15 seconds! You don't have to do anything except manage your system as you wish!  </p><p>We therefore advise you to use Timeshift to create and manage your BTRFS snapshots.</p><h3 id="snapshots-with-timeshift" class="section-heading"><a href="#snapshots-with-timeshift" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Snapshots with Timeshift</span></h3><p>Snapshots with Timeshift, software available in CLI or GUI, the snapshots can be taken much more easily that with btrfs-progs commands.<br/>We recommend the use of Timeshift to take and restore snapshot of your system.  </p><p>Remember to regularly delete your BTRFS snapshots taken with Timeshift, they can take up considerable space on your storage device.  </p><p>The timeshift manpage is available on Kaisen as well as all related documentation.</p><h3 id="restore-snapshots-from-a-chrooted-environment" class="section-heading"><a href="#restore-snapshots-from-a-chrooted-environment" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Restore snapshots from a chrooted environment</span></h3><p>In case of a major crash (if your system does not boot), if the grub-btrfs software does not display anything, GRUB is not accessible, or an error has occurred, you can potentially recover your system from a <a href="create-chroot.html">chrooted environment</a>. There are many potential causes. In case of difficulties, the Kaisen Linux discussion groups or the official community forum can help you.</p><h2 id="recommendations-for-btrfs" class="section-heading"><a href="#recommendations-for-btrfs" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Recommendations for BTRFS</span></h2><p>This is not enabled by default for performance reasons as well as to avoid premature wear, automated defragmentation is disabled.<br/>It is advisable to defragment BTRFS volumes at least every 6 months (CoW can create significant fragmentation), even on SSDs.<br/>Delete the snapshots first, and then type the command (in case you have BTRFS installed on the root):<br/><code class="inline">sudo btrfs filesystem defragment -rv /</code>  </p><p>You can also use the btrfs-balance-least-used command to rebalance unbalanced pieces of data. Running this command can potentially allow for the recovery of space on the disk.    </p><p>Example for the / partition :<br/><code class="inline">btrfs-balance-least-used /</code></p><h2 id="docker-with-btrfs" class="section-heading"><a href="#docker-with-btrfs" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Docker with BTRFS</span></h2><p>Docker on Kaisen Linux has been packaged to support the use of BTRFS. For this, Docker has been packaged to use the overlay2 driver as default driver, even if BTRFS is the filesystem used. So you can safely use Docker with BTRFS!</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="terminal-shortcuts.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Kaisen Terminal shortcuts
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="create-chroot.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Create chroot
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
